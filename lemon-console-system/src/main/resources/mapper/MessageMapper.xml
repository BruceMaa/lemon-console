<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.onesorigin.lemon.console.system.mapper.MessageMapper">

    <resultMap id="message" type="cn.onesorigin.lemon.console.system.model.resp.MessageResp">
        <id property="id" column="id"/>
    </resultMap>
    <resultMap id="messageDetail" type="cn.onesorigin.lemon.console.system.model.resp.MessageDetailResp">
        <id property="id" column="id"/>
        <result property="users" column="users"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
    </resultMap>

    <select id="findUnreadCountByUserIdAndType" resultType="java.lang.Long">
        SELECT
        COUNT(1)
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id AND t2.user_id = #{userId}
        WHERE
        (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{userId}::text)))
        AND t2.read_time IS NULL
        <if test="type != null">
            AND t1.type = #{type}
        </if>
    </select>
    <select id="findPage" resultMap="message">
        SELECT
        t1.id,
        t1.title,
        t1.type,
        t1.path,
        t1.created_at,
        t2.read_time IS NOT NULL AS isRead,
        t2.read_time AS readTime
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id
        <where>
            <if test="query.userId != null">
                (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{query.userId}::text)))
            </if>
            <if test="query.title != null and query.title != ''">
                AND t1.title LIKE '%' || #{query.title} || '%'
            </if>
            <if test="query.type != null and query.type != ''">
                AND t1.type = #{query.type}
            </if>
            <if test="query.isRead != null">
                AND t2.read_time IS <if test="query.isRead">NOT</if> NULL
            </if>
        </where>
        ORDER BY t1.created_at DESC
    </select>
    <select id="findDetailById" resultMap="messageDetail">
        SELECT
        t1.id,
        t1.title,
        t1.content,
        t1.type,
        t1.path,
        t1.scope,
        t1.users,
        t1.created_at,
        t2.read_time IS NOT NULL AS isRead,
        t2.read_time AS readTime
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id
        WHERE t1.id = #{id}
    </select>
    <select id="findUnreadListByUserId" resultType="cn.onesorigin.lemon.console.system.model.entity.MessageDO">
        SELECT
        t1.*
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id AND t2.user_id = #{userId}
        WHERE
        (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{userId}::text)))
        AND t2.read_time IS NULL
    </select>
</mapper>
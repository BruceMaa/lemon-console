<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.onesorigin.lemon.console.system.mapper.NoticeMapper">

    <resultMap id="notice" type="cn.onesorigin.lemon.console.system.model.resp.NoticeResp">
        <id property="id" column="id"/>
        <result property="noticeMethods" column="notice_methods"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
    </resultMap>

    <select id="findNotices" resultMap="notice">
        SELECT
        t1.id,
        t1.title,
        t1.type,
        t1.notice_scope,
        t1.notice_methods,
        t1.is_timing,
        t1.publish_time,
        t1.is_top,
        t1.status,
        t1.created_by
        <if test="query.userId != null">
            ,t2.read_time IS NOT NULL AS isRead
        </if>
        FROM sys_notice AS t1
        <if test="query.userId != null">
            LEFT JOIN sys_notice_log AS t2 ON t2.notice_id = t1.id AND t2.user_id = #{query.userId}
        </if>
        <where>
            <if test="query.userId != null">
                (t1.notice_scope = 1 OR (t1.notice_scope = 2 AND t1.notice_users::jsonb @>
                jsonb_build_array(#{query.userId}::text)))
            </if>
            <if test="query.title != null and query.title != ''">
                AND t1.title LIKE '%' || #{query.title} || '%'
            </if>
            <if test="query.type != null and query.type != ''">
                AND t1.type = #{query.type}
            </if>
        </where>
        <if test="query.userId != null">
            ORDER BY t1.is_top DESC, t1.publish_time DESC
        </if>
        <if test="query.userId == null">
            ORDER BY t1.created_at DESC
        </if>
    </select>
    <select id="findUnreadIdsByUserId" resultType="java.lang.Long">
        SELECT
        t1.id
        FROM sys_notice AS t1
        LEFT JOIN sys_notice_log AS t2 ON t2.notice_id = t1.id AND t2.user_id = #{userId}
        WHERE
        (t1.notice_scope = 1 OR (t1.notice_scope = 2 AND t1.notice_users::jsonb @> jsonb_build_array(#{userId}::text)))
        <if test="noticeMethod != null">
            AND (t1.notice_methods::jsonb @> jsonb_build_array(#{noticeMethod}::text))
        </if>
        AND t2.read_time IS NULL
    </select>
    <select id="findDashboardList"
            resultType="cn.onesorigin.lemon.console.system.model.resp.DashboardNoticeResp">
        SELECT
        id, title, type, is_top
        FROM sys_notice
        WHERE status = 3
        <if test="userId != null">
            AND (notice_scope = 1 OR (notice_scope = 2 AND notice_users::jsonb @> jsonb_build_array(#{userId}::text)))
        </if>
        ORDER BY is_top DESC, publish_time DESC
        LIMIT 5
    </select>
</mapper>
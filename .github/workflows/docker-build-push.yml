name: Publish Docker Image  # 工作流名称，显示在GitHub Actions界面

on:
  push:
    tags: [ 'v*.*.*' ]  # 触发条件：仅当推送符合vX.Y.Z格式的tag时运行（如v1.0.0）

jobs:
  push_to_registry:
    name: Push Docker Image  # 任务名称
    runs-on: ubuntu-latest   # 运行环境：最新版Ubuntu

    steps:
      # 步骤1：检出代码
      - name: Checkout Code
        uses: actions/checkout@v4  # 官方action，用于拉取仓库代码
        with:
          fetch-depth: 0  # 获取完整git历史记录（用于版本号提取）

      # 步骤2、安装 Java 环境
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "adopt"
          java-version: 17
          cache: "maven"

      # 步骤3：本地打包测试（可选，确保构建没问题）
      - name: Build with Maven
        run: |
          sed -i.bak '/<repositories>/,/<\/repositories>/d' pom.xml
          sed -i.bak '/<pluginRepositories>/,/<\/pluginRepositories>/d' pom.xml
          mvn -B clean package -DskipTests

      # 步骤4：设置Docker Buildx（多平台构建工具）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # 配置Buildx环境

      # 步骤5：登录Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}  # 从GitHub Secrets读取用户名
          password: ${{ secrets.DOCKER_HUB_TOKEN }}  # 从GitHub Secrets读取访问令牌

      # 步骤6：生成镜像标签
      - name: Extract Version Tags
        id: meta  # 步骤ID，用于后续引用输出
        uses: docker/metadata-action@v5  # 自动生成标签和元数据
        with:
          images: ${{ secrets.DOCKER_HUB_USERNAME }}/lemon-console  # 目标镜像名称（格式：用户名/仓库名）
          flavor: |
            latest=false  # 禁用metadata-action默认的latest标签生成逻辑
          tags: |  # 自定义标签规则（注意缩进）
            # 硬编码latest标签，仅当推送tag时生成
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}
            # 从git tag提取完整版本号（如v1.0.0 → 1.0.0）
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      # 步骤7：构建并推送镜像
      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文：当前目录
          push: true  # 启用推送（因为触发条件已限定为tag推送）
          tags: ${{ steps.meta.outputs.tags }}  # 使用前一步生成的标签
          labels: ${{ steps.meta.outputs.labels }}  # 自动生成的镜像标签
          # 构建缓存配置（从指定镜像拉取缓存）
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/lemon-console:buildcache
          # 将构建缓存推送到指定镜像（模式设为max以包含全部缓存层）
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/lemon-console:buildcache,mode=max
